---
title: "Data_Analysis_2"
author: "Sebastian Robledo"
date: "8/18/2021"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Creating the environment

```{r}
library(tidyverse)
library(here)
library(revtools)
library(ggpubr) 
library(gt)
library(dplyr)
library(formattable)
library(readxl)
library(googlesheets4)
library(sjrdata)
library(knitr)
library(kableExtra)
library(apaTables)
library(bibliometrix)
library(igraph)
library(tosr)
library(rebus)
library(lubridate)
```


# Getting tidied data 

```{r message=FALSE, warning=FALSE}
data_tidied <- 
  read_csv(here("output",
                "mendelely_tags_wos_scopus.csv"))

data_tidied_wos <- 
  data_tidied |>
  select(SR, CR) |> 
  separate_rows(CR, sep = "; ") |> # Scopus
  count(SR) |>
  filter(n == 1) |> 
  select(SR) |> 
  mutate(database = "wos")

data_tidied <- 
  data_tidied |> 
  left_join(data_tidied_wos) |> 
  mutate(database = if_else(is.na(database), 
                            "Scopus", 
                            database))

```


# 3.1 Academic production of coffee By-products 
## 3.1.1 Annual scientific production

```{r}
byproducts_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.integer(year))

# We need to create a range sequence of years

byproduct_years <- 
  range(data_tidied$year)  

byproduct_year_range <- 
  byproduct_years[1]:byproduct_years[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to husk dataset

byproduct_year_all <-
  byproduct_year_range %>% 
  left_join(byproducts_year) %>% 
  replace_na(list(papers = 0)) 

mendeley_byproducts_plot <- 
  byproduct_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() +
  geom_line() +
  ylab("papers") +
  ggtitle("Scientific annual production") +
  theme(plot.title = element_text(hjust = 0.5),
        text=element_text(family="Times", face="bold", size=12),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())

## Coffee husk 

husk_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |>
  filter(str_detect(string = byproduct,
                    pattern = "husk")) |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(desc(year)) 

# We need to create a range sequence of years

husk_range_year <- 
  range(husk_year$year)  

husk_years <- 
  husk_range_year[1]:husk_range_year[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to husk dataset

husk_year_all <-
  husk_years %>% 
  left_join(husk_year) %>% 
  replace_na(list(papers = 0)) 

husk_year_all_plot <- 
  husk_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() +
  geom_line() +
  ylab("papers") +
  ggtitle("Husk") +
  theme(plot.title = element_text(hjust = 0.5),
        text=element_text(family="Times", face="bold", size=12),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())


## Coffee pulp 

pulp_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |>
  filter(str_detect(string = byproduct,
                    pattern = "pulp")) |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(desc(year)) 

# We need to create a range sequence of years

pulp_range_year <- 
  range(pulp_year$year)  

pulp_years <- 
  pulp_range_year[1]:pulp_range_year[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to pulp dataset

pulp_year_all <-
  pulp_years %>% 
  left_join(pulp_year) %>% 
  replace_na(list(papers = 0)) 

pulp_year_all_plot <- 
  pulp_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() + 
  geom_line() +
  ggtitle("Pulp")


## Coffee silverskin 

silverskin_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |>
  filter(str_detect(string = byproduct,
                    pattern = "silverskin")) |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(desc(year)) 

# We need to create a range sequence of years

silverskin_range_year <- 
  range(silverskin_year$year)  

silverskin_years <- 
  silverskin_range_year[1]:silverskin_range_year[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to silverskin dataset

silverskin_year_all <-
  silverskin_years %>% 
  left_join(silverskin_year) %>% 
  replace_na(list(papers = 0)) 

silverskin_year_all_plot <- 
  silverskin_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() + 
  geom_line() +
  ggtitle("Silverskin")



## Coffee Spent_coffee 

Spent_coffee_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |>
  filter(str_detect(string = byproduct,
                    pattern = "spent_coffee_grounds")) |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(desc(year)) 

# We need to create a range sequence of years

Spent_coffee_range_year <- 
  range(Spent_coffee_year$year)  

Spent_coffee_years <- 
  Spent_coffee_range_year[1]:Spent_coffee_range_year[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to Spent_coffee dataset

Spent_coffee_year_all <-
  Spent_coffee_years %>% 
  left_join(Spent_coffee_year) %>% 
  replace_na(list(papers = 0)) 

Spent_coffee_year_all_plot <- 
  Spent_coffee_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() + 
  geom_line() +
  ggtitle("Spent coffee ground")


## Annual scientific production

global_scientific_production <- 
  ggarrange(mendeley_byproducts_plot,
            ggarrange(husk_year_all_plot, pulp_year_all_plot, 
                      ncol = 2, labels = c("b", "d"), 
                      align = "h",widths = c(1.5,2)), 
            ggarrange(silverskin_year_all_plot, Spent_coffee_year_all_plot,
                      ncol = 2, labels = c("c", "e"), 
                      align = "h",widths = c(1.5,2)), 
            nrow = 3, 
            heights = c(1.5, 1, 1),
            labels = "a" 
  ) 

global_scientific_production
```

Add trending lines

## 3.1.2 Journal production

```{r}
data_tidied |> 
  ungroup() %>% 
  dplyr::select(doi, byproduct, SO ) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |> 
  count(SO, sort = TRUE) |> 
  slice(1:5)
```

What if we split by byproducts? 

```{r}
husk_journals <- 
  data_tidied |> 
  filter(str_detect(string = byproduct, pattern = "husk"),
         year >= 2016) |> 
  count(SO,sort = TRUE) |> 
  slice(1:3) |> 
  mutate(byproduct = "husk")

pulp_journals <- 
  data_tidied |> 
  filter(str_detect(string = byproduct, pattern = "pulp"), 
         year >= 2016) |> 
  count(SO,sort = TRUE) |> 
  slice(1:3)|> 
  mutate(byproduct = "pulp")

silverskin_journals <- 
  data_tidied |> 
  filter(str_detect(string = byproduct, pattern = "silverskin"), 
         year >= 2016) |> 
  count(SO,sort = TRUE) |> 
  slice(1:3)|> 
  mutate(byproduct = "silverskin")

spent_coffee_ground <- 
  data_tidied |> 
  filter(str_detect(string = byproduct, pattern = "spent_coffee_grounds"), 
         year >= 2016) |> 
  count(SO,sort = TRUE) |> 
  slice(1:3)|> 
  mutate(byproduct = "spent_cofee_ground")

byproducts_journals <- 
  bind_rows(husk_journals,
            pulp_journals,
            silverskin_journals,
            spent_coffee_ground) |> 
  rename("papers" = n) |> 
  mutate(SO = replace(SO, SO %in% "LWT-FOOD SCIENCE AND TECHNOLOGY", 
                      "LWT - Food Science and Technology"), 
         SO = str_to_upper(SO))

byproducts_journals_scimago <- 
  sjr_journals |> 
  mutate(title  = str_to_upper(title)) |>
  filter(year == 2019) |> 
  select(title, h_index, sjr_best_quartile) |> 
  right_join(byproducts_journals, 
             by = c("title" = "SO")) |> 
  select(byproduct, everything()) |> 
  arrange(desc(byproduct))

byproducts_journals_scimago
```

## 3.1.3 Author analysis

```{r}
husk_authors <- 
  data_tidied |> 
  filter(str_detect(byproduct, pattern = "husk")) |> 
  select(doi, AU) |>
  unique() |> 
  separate_rows(AU, sep = ";") |> 
  count(AU, sort = TRUE) |> 
  mutate(byproduct = "husk") |> 
  slice(1:3)

husk_authors

pulp_authors <- 
  data_tidied |> 
  filter(str_detect(byproduct, pattern = "pulp")) |> 
  select(doi, AU) |>
  unique() |> 
  separate_rows(AU, sep = ";") |> 
  count(AU, sort = TRUE) |> 
  mutate(byproduct = "pulp") |> 
  slice(1:3)

silverskin_authors <- 
  data_tidied |> 
  filter(str_detect(byproduct, pattern = "silverskin")) |> 
  select(doi, AU) |>
  unique() |> 
  separate_rows(AU, sep = ";") |> 
  count(AU, sort = TRUE) |> 
  mutate(byproduct = "silverskin") |> 
  slice(1:3)

spent_coffee_ground_authors <- 
  data_tidied |> 
  filter(str_detect(byproduct, pattern = "spent_coffee_ground")) |> 
  select(doi, AU) |>
  unique() |> 
  separate_rows(AU, sep = ";") |> 
  count(AU, sort = TRUE) |> 
  mutate(byproduct = "spent_coffee_ground") |> 
  slice(1:3)

byproducts_authors <- 
  bind_rows(husk_authors,
            pulp_authors,
            silverskin_authors,
            spent_coffee_ground_authors) |> 
  rename("papers" = n) |> 
  select(byproduct, everything()) |> 
  arrange(desc(byproduct))

byproducts_authors
```

```{r}
M <- data_tidied |> 
  rename("TI" = title)
k <- 10
M$TC <- as.numeric(M$TC)
data_tidied$PY <- as.numeric(data_tidied$PY)
data_tidied <- data_tidied[!is.na(data_tidied$PY), ]
AU <- names(tableTag(M, "AU"))
k <- min(k, length(AU))
AU <- AU[1:k]
df <- data.frame(Author = "NA", year = NA, TI = "NA", SO = "NA", 
                 DOI = "NA", TC = NA, TCpY = NA, stringsAsFactors = FALSE)
Y <- as.numeric(substr(Sys.time(), 1, 4))
if (!("DI" %in% names(M))) {
  M$DI = "NA"
}
for (i in 1:length(AU)) {
  ind <- which(regexpr(AU[i], M$AU) > -1)
  TCpY <- M$TC[ind]/(Y - M$PY[ind] + 1)
  dfAU <- data.frame(Author = rep(AU[i], length(ind)), 
                     year = M$PY[ind], TI = M$TI[ind], SO = M$SO[ind], 
                     DOI = M$DI[ind], TC = M$TC[ind], TCpY = TCpY, stringsAsFactors = TRUE)
  df <- rbind(df, dfAU)
}
df <- df[-1, ]
df2 <- dplyr::group_by(df, .data$Author, .data$year) %>% 
  dplyr::summarise(freq = length(.data$year), TC = sum(.data$TC), 
                   TCpY = sum(.data$TCpY))
df2 <- as.data.frame(df2)
df2$Author <- factor(df2$Author, levels = AU[1:k])
x <- c(0.5, 1.5 * k/10)
y <- c(min(df$year), min(df$year) + diff(range(df2$year)) * 
         0.125)

```


```{r}
g <- ggplot(df2, aes(x = Author, 
                     y = year, 
                     text = paste("Author: ",
                                  Author, "\nYear: ",
                                  year, "\nN. of Articles: ",
                                  freq, "\nTotal Citations per Year: ",
                                  round(TCpY,
                                        2)
                     )
)
) + 
  geom_point(aes(alpha = TCpY, 
                 size = freq), 
             color = "dodgerblue4") + 
  scale_size(range = c(2, 6)) + 
  scale_alpha(range = c(0.3, 1)) + 
  scale_y_continuous(breaks = seq(min(df2$year), 
                                  max(df2$year), 
                                  by = 2)) + 
  guides(size = guide_legend(order = 1,
                             "N.Articles"), 
         alpha = guide_legend(order = 2, 
                              "TC per Year")) + 
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "Top-Authors' Production over the Time", 
       x = "Author", y = "Year") + 
  geom_line(data = df2, 
            aes(x = Author, y = year, group = Author),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(df2$Author))) + 
  coord_flip()
```

```{r}
g
```

## 3.1.4 Country Analysis

```{r}
husk_country <- 
  data_tidied |> 
  filter(str_detect(byproduct, 
                    pattern = "husk")) |> 
  biblioAnalysis(sep = "; ") |> 
  plot()

husk_country_plot <- 
  husk_country$MostProdCountries +
  labs(title = "husk")

pulp_country <- 
  data_tidied |> 
  filter(str_detect(byproduct, 
                    pattern = "pulp")) |> 
  biblioAnalysis(sep = "; ") |> 
  plot()

pulp_country_plot <- 
  pulp_country$MostProdCountries +
  labs(title = "pulp")

silverskin_country <- 
  data_tidied |> 
  filter(str_detect(byproduct, 
                    pattern = "silverskin")) |> 
  biblioAnalysis(sep = "; ") |> 
  plot()

silverskin_country_plot <- 
  silverskin_country$MostProdCountries +
  labs(title = "silverskin")

spent_coffee_ground_country <- 
  data_tidied |> 
  filter(str_detect(byproduct, 
                    pattern = "spent_coffee_grounds")) |> 
  biblioAnalysis(sep = "; ") |> 
  plot()

spent_coffee_ground_country_plot <- 
  spent_coffee_ground_country$MostProdCountries +
  labs(title = "spent_coffee_grounds")

country_scientific_production <- 
  ggarrange(
    ggarrange(spent_coffee_ground_country_plot, silverskin_country_plot, 
              ncol = 2, labels = c("a", "b"), 
              align = "h",widths = c(1.5,2)), 
    ggarrange(pulp_country_plot, husk_country_plot,
              ncol = 2, labels = c("c", "d"), 
              align = "h",widths = c(1.5,2)), 
    nrow = 2
  ) 

country_scientific_production
```

Add one in general?

# 3.2 Academic networks of Coffee By-products 

## 3.2.1 Collab net author

```{r}

author_colab <- 
  biblioNetwork(data.frame(data_tidied), 
                analysis = "collaboration", 
                network = "authors", 
                sep = ";")

net=networkPlot(author_colab, n = 30, 
                Title = "Author Collaboration Network", 
                type = "fruchterman", 
                size=T,
                remove.multiple=FALSE, 
                labelsize=0.7,
                edgesize = 5,
                cluster = 'louvain')

author_colab_graph <- 
  graph_from_adjacency_matrix(adjmatrix = author_colab, 
                              mode = "undirected", 
                              weighted = TRUE) |> 
  simplify()

```

The results are scattered in author collaboration network.  

## 3.2.2 Collab net country

```{r}
M <- metaTagExtraction(data_tidied, 
                       Field = "AU_CO", 
                       sep = ";")

country_collab <- 
  biblioNetwork(data.frame(M), 
                analysis = "collaboration", 
                network = "countries", 
                sep = ";")

net=networkPlot(country_collab, 
                n = dim(country_collab)[1], 
                Title = "Country Collaboration", 
                type = "circle", 
                size=TRUE, 
                remove.multiple=FALSE,
                labelsize=0.7,
                cluster="none")

country_collab_graph <- 
  graph_from_adjacency_matrix(country_collab, 
                              mode = "undirected", 
                              weighted = TRUE) |> 
  simplify()
```
I couldn't create the world map :-( 

## 3.2.3 Collab net universities

```{r}
university_collab <- 
  biblioNetwork(data.frame(data_tidied), 
                analysis = "collaboration", 
                network = "universities", 
                sep = ";")

university_collab_net <- networkPlot(university_collab, 
                                     n = dim(universty_collab)[1], 
                                     Title = "University Collaboration", 
                                     type = "circle", 
                                     size=TRUE, 
                                     remove.multiple=FALSE,
                                     labelsize=0.7,
                                     cluster="none")

# university_collab_graph <- 
#   graph_from_adjacency_matrix(universty_collab_net$graph, 
#                               mode = "undirected", 
#                               weighted = TRUE) |> 
#   simplify()
```

Scattered.... 

## 3.2.4 Citation Network

```{r}
edgelist_scopus <- 
  data_tidied |>
  filter(str_detect(database, 
                    "Scopus")) |> 
  select(SR, CR, database, SO) |> 
  separate_rows(CR, sep = "; ") |> 
  mutate(SR_TOS = str_extract(SR, one_or_more(WRD) %R%
                                SPC %R% one_or_more(WRD) %R%
                                "," %R% SPC %R%
                                one_or_more(DGT) %R% ","),
         SR_TOS = str_c(SR_TOS, " ", SO)) %>%
  mutate(ID_TOS =str_extract(SR, ".*,")) |> 
  select(ID_TOS, CR) |> 
  mutate(lastname = sub("\\., .*", "", CR),
         lastname = sub(",", "", lastname),
         lastname = sub("\\.", "", lastname),
         year = str_extract(CR, "\\(([0-9]{4})\\)"),
         year = str_remove_all(year, "\\(|\\)")) |> 
  filter(!grepl(pattern = "[():[:digit:]]", lastname),
         str_length(year) == 4) |> 
  mutate(CR = paste0(lastname, ", ", year, ",")) %>%
  select(ID_TOS, CR)

edgelist_wos <- 
  data_tidied |>
  filter(str_detect(database, 
                    "wos")) |> 
  select(SR, CR, database, SO) |> 
  separate_rows(CR, sep = ";") |> 
  mutate(ID_TOS = str_extract(SR, ".*,")) |> 
  mutate(CR = sub("^(\\S*\\s+\\S+\\s+\\S+).*", # removing strings after second comma
                  "\\1", CR)) %>%
  select(ID_TOS, CR) %>%
  na.omit() %>%
  unique() 

edgelist <- 
  edgelist_scopus |> 
  bind_rows(edgelist_wos) |> 
  mutate(CR = str_replace_all(CR, 
                              pattern = "\\.", 
                              replacement = ""))

byproducts_graph_raw <- 
  edgelist |> 
  graph.data.frame(directed = TRUE) |> 
  simplify()

byproducts_graph_cleaned <- 
  delete.vertices(byproducts_graph_raw, 
                  which(degree(byproducts_graph_raw, 
                               mode = "in") == 1 &
                          which(degree(byproducts_graph_raw, 
                                       mode = "out") == 0)))

giant.component <- function(graph) {
  cl <- igraph::clusters(graph)
  igraph::induced.subgraph(graph, which(cl$membership == which.max(cl$csize)))
}

byproducts_graph <- 
  giant.component(byproducts_graph_cleaned)

subareas <- 
  byproducts_graph |> 
  as.undirected(mode = "each") |> 
  cluster_louvain()

byproducts_graph_subareas <- 
  byproducts_graph |> 
  set_vertex_attr(name = "sub_area",
                  value = membership(subareas))

write.graph(byproducts_graph_subareas, 
            here("output", 
                 "byproducts_citation_network.graphml" ), 
            format = "graphml")
```

## 3.2.5 Co-citation analysis

Document

```{r}
document_co_citation_matrix <- 
  biblioNetwork(data.frame(data_tidied),
                analysis = "co-citation", 
                network = "references", 
                sep = ";")

net=networkPlot(document_co_citation_matrix, 
                n = 80, 
                Title = "Co-Citation Network", 
                type = "fruchterman", 
                size.cex=TRUE, 
                size=20, 
                remove.multiple=FALSE, 
                labelsize=0.7,
                edgesize = 10, 
                edges.min=5)
```

Author

```{r}
author_co_citation_matrix <- 
  biblioNetwork(data.frame(data_tidied),
                analysis = "co-citation", 
                network = "author", 
                sep = ";")

net=networkPlot(author_co_citation_matrix, 
                n = 80, 
                Title = "Co-Citation Network", 
                type = "fruchterman", 
                size.cex=TRUE, 
                size=20, 
                remove.multiple=FALSE, 
                labelsize=0.7,
                edgesize = 10, 
                edges.min=5)
```

Journal?

https://www.bibliometrix.org/vignettes/Introduction_to_bibliometrix.html

https://bibliometrix.org/documents/bibliometrix_Report.html

# 3.3 Coffee By-products applications

## 3.3.1 Husk

```{r}
data_tidied_husk  <- 
  data_tidied %>% 
  separate_rows(byproduct, sep = ", ") |> 
  separate_rows(categories, sep = ", ") |> 
  filter(str_detect(byproduct, pattern = "husk")) %>% 
  group_by(year,categories) %>% 
  count(categories, sort = TRUE)

data_tidied_husk_plot <- 
  data_tidied_husk %>% 
  arrange(year,categories) %>% 
  mutate(categories = factor(categories)) %>% 
  ggplot(aes(y = categories, x = year, size = n, color= categories)) +
  geom_point(alpha = 1) +
  scale_x_continuous(breaks = seq(min(data_tidied_husk$year),
                                  max(data_tidied_husk$year),
                                  by = 1)) +
  scale_size(name="tags") +
  xlab("Byproducts Applications") +
  ggtitle("Husk applications") +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 10, angle = 0,vjust = 0),
        axis.text.y = element_text(face = "bold", 
                                   size = 10, angle = 0,hjust = 1)) +
  #scale_y_continuous(breaks = seq(2003,2020)) + 
  guides(color = FALSE)

data_tidied_husk_plot
```




