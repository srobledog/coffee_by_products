---
title: "Data_Analysis_2"
author: "Sebastian Robledo"
date: "8/18/2021"
output: 
  html_document:
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Creating the environment

```{r}
library(tidyverse)
library(here)
library(revtools)
library(ggpubr) 
library(gt)
library(dplyr)
library(formattable)
library(readxl)
library(googlesheets4)
library(sjrdata)
library(knitr)
library(kableExtra)
library(apaTables)
library(bibliometrix)
library(igraph)
library(tosr)
library(rebus)
library(lubridate)
library(zoo)
library(XML)
library(plyr)
library(sjrdata)
library(journalabbr)
```


# Getting tidied data 

```{r message=FALSE, warning=FALSE}
data_tidied <- 
  read_csv(here("output",
                "mendelely_tags_wos_scopus.csv"))

data_tidied_wos <- 
  data_tidied |>
  select(SR, CR) |> 
  separate_rows(CR, sep = "; ") |> # Scopus
  count(SR) |>
  filter(n == 1) |> 
  select(SR) |> 
  mutate(database = "wos")

data_tidied <- 
  data_tidied |> 
  left_join(data_tidied_wos) |> 
  mutate(database = if_else(is.na(database), 
                            "Scopus", 
                            database))

```


# 3.1 Academic production of coffee By-products 
## 3.1.1 Annual scientific production

```{r}
byproducts_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.integer(year))

# We need to create a range sequence of years

byproduct_years <- 
  range(data_tidied$year)  

byproduct_year_range <- 
  byproduct_years[1]:byproduct_years[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to husk dataset

byproduct_year_all <-
  byproduct_year_range %>% 
  left_join(byproducts_year) %>% 
  replace_na(list(papers = 0)) 

mendeley_byproducts_plot <- 
  byproduct_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() +
  geom_line() +
  labs(title = "Total Scientific Annual Production", 
       x = "year")  +
  theme(plot.title = element_text(hjust = 0.5),
        text=element_text(family="Times", face="bold", size=12),
        axis.line = element_line(colour = "black"),
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        # panel.background = element_blank()
  )

## Coffee husk 

husk_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |>
  filter(str_detect(string = byproduct,
                    pattern = "husk")) |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(desc(year)) 

# We need to create a range sequence of years

husk_range_year <- 
  range(husk_year$year)  

husk_years <- 
  husk_range_year[1]:husk_range_year[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to husk dataset

husk_year_all <-
  husk_years %>% 
  left_join(husk_year) %>% 
  replace_na(list(papers = 0)) 

husk_year_all_plot <- 
  husk_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() +
  geom_line() +
  ylab("papers") +
  ggtitle("Husk") +
  theme(plot.title = element_text(hjust = 0.5),
        text=element_text(family="Times", 
                          face="bold", 
                          size=12),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank())

## Coffee pulp 

pulp_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |>
  filter(str_detect(string = byproduct,
                    pattern = "pulp")) |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(desc(year)) 

# We need to create a range sequence of years

pulp_range_year <- 
  range(pulp_year$year)  

pulp_years <- 
  pulp_range_year[1]:pulp_range_year[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to pulp dataset

pulp_year_all <-
  pulp_years %>% 
  left_join(pulp_year) %>% 
  replace_na(list(papers = 0)) 

pulp_year_all_plot <- 
  pulp_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() + 
  geom_line() +
  ggtitle("Pulp") +
  theme(plot.title = element_text(hjust = 0.5),
        text=element_text(family="Times", 
                          face="bold", 
                          size=12),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank())


## Coffee silverskin 

silverskin_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |>
  filter(str_detect(string = byproduct,
                    pattern = "silverskin")) |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(desc(year)) 

# We need to create a range sequence of years

silverskin_range_year <- 
  range(silverskin_year$year)  

silverskin_years <- 
  silverskin_range_year[1]:silverskin_range_year[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to silverskin dataset

silverskin_year_all <-
  silverskin_years %>% 
  left_join(silverskin_year) %>% 
  replace_na(list(papers = 0)) 

silverskin_year_all_plot <- 
  silverskin_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() + 
  geom_line() +
  ggtitle("Silverskin") +
  theme(plot.title = element_text(hjust = 0.5),
        text=element_text(family="Times", 
                          face="bold", 
                          size=12),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank())



## Coffee Spent_coffee 

Spent_coffee_year <- 
  data_tidied %>% 
  ungroup() %>% 
  dplyr::select(doi, byproduct, year) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |>
  filter(str_detect(string = byproduct,
                    pattern = "spent_coffee_grounds")) |> 
  count(year, sort = TRUE) %>% 
  rename("papers" = n) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(desc(year)) 

# We need to create a range sequence of years

Spent_coffee_range_year <- 
  range(Spent_coffee_year$year)  

Spent_coffee_years <- 
  Spent_coffee_range_year[1]:Spent_coffee_range_year[2]%>% 
  as_tibble() %>% 
  rename("year" = value)

# Adding range years to Spent_coffee dataset

Spent_coffee_year_all <-
  Spent_coffee_years %>% 
  left_join(Spent_coffee_year) %>% 
  replace_na(list(papers = 0)) 

Spent_coffee_year_all_plot <- 
  Spent_coffee_year_all %>% 
  ggplot(aes(x = year, y = papers, group = 1)) +
  geom_point() + 
  geom_line() +
  ggtitle("Spent coffee ground")  +
  theme(plot.title = element_text(hjust = 0.5),
        text=element_text(family="Times", 
                          face="bold", 
                          size=12),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank())


## Annual scientific production

global_scientific_production <- 
  ggarrange(mendeley_byproducts_plot,
            ggarrange(husk_year_all_plot, pulp_year_all_plot, 
                      ncol = 2, labels = c("b", "c"), 
                      align = "h",widths = c(1.5,2)), 
            ggarrange(silverskin_year_all_plot, Spent_coffee_year_all_plot,
                      ncol = 2, labels = c("d", "e"), 
                      align = "h",widths = c(1.5,2)), 
            nrow = 3, 
            heights = c(1.5, 1, 1),
            labels = "a" 
  ) 

global_scientific_production 
```

Add trending lines

## 3.1.2 Journal production

```{r}
data_tidied |> 
  ungroup() %>% 
  dplyr::select(doi, byproduct, SO ) %>% 
  separate_rows(byproduct, sep = ", ") |> 
  unique() |> 
  count(SO, sort = TRUE) |> 
  slice(1:5)
```

What if we split by byproducts? 

```{r}
husk_journals <- 
  data_tidied |> 
  filter(str_detect(string = byproduct, pattern = "husk"),
         year >= 2016) |> 
  count(SO,sort = TRUE) |> 
  slice(1:3) |> 
  mutate(byproduct = "husk")

pulp_journals <- 
  data_tidied |> 
  filter(str_detect(string = byproduct, pattern = "pulp"), 
         year >= 2016) |> 
  count(SO,sort = TRUE) |> 
  slice(1:3)|> 
  mutate(byproduct = "pulp")

silverskin_journals <- 
  data_tidied |> 
  filter(str_detect(string = byproduct, pattern = "silverskin"), 
         year >= 2016) |> 
  count(SO,sort = TRUE) |> 
  slice(1:3)|> 
  mutate(byproduct = "silverskin")

spent_coffee_ground <- 
  data_tidied |> 
  filter(str_detect(string = byproduct, pattern = "spent_coffee_grounds"), 
         year >= 2016) |> 
  count(SO,sort = TRUE) |> 
  slice(1:3)|> 
  mutate(byproduct = "spent_cofee_ground")

byproducts_journals <- 
  bind_rows(husk_journals,
            pulp_journals,
            silverskin_journals,
            spent_coffee_ground) |> 
  rename("papers" = n) |> 
  mutate(SO = replace(SO, SO %in% "LWT-FOOD SCIENCE AND TECHNOLOGY", 
                      "LWT - Food Science and Technology"), 
         SO = str_to_upper(SO))

byproducts_journals_scimago <- 
  sjr_journals |> 
  mutate(title  = str_to_upper(title)) |>
  filter(year == 2019) |> 
  select(title, h_index, sjr_best_quartile) |> 
  right_join(byproducts_journals, 
             by = c("title" = "SO")) |> 
  select(byproduct, everything()) |> 
  arrange(desc(byproduct))

byproducts_journals_scimago
```

### Husk

```{r}
M_journal_husk <- 
  data_tidied |> 
  rename("TI" = title) |> 
  filter(byproduct %in% "husk") # maybe there is a mistake here
k_husk <- 12
M_journal_husk$TC <- as.numeric(M_journal_husk$TC)
data_tidied$PY <- as.numeric(data_tidied$PY)
data_tidied <- data_tidied[!is.na(data_tidied$PY), ]
SO <- names(tableTag(M_journal_husk, "SO"))
k_husk <- min(k_husk, length(SO))
SO <- SO[1:k_husk]
df_journal_husk <- tibble()
Y <- as.numeric(substr(Sys.time(), 1, 4))
if (!("DI" %in% names(M_journal_husk))) {
  M_journal$DI = "NA"
}
for (i in 1:length(SO)) {
  ind <- which(regexpr(SO[i], M_journal_husk$SO) > -1)
  TCpY <- M$TC[ind]/(Y - M$PY[ind] + 1)
  dfSO <- data.frame(Journal = rep(SO[i], length(ind)), 
                     year = M_journal$PY[ind], TI = M_journal_husk$TI[ind], 
                     SO = M_journal_husk$SO[ind], DOI = M_journal_husk$DI[ind], 
                     TC = M_journal_husk$TC[ind], TCpY = TCpY, 
                     stringsAsFactors = TRUE)
  df_journal_husk <- bind_rows(df_journal_husk, dfSO)
}
df2_journal_husk <- dplyr::group_by(df_journal_husk, 
                                    .data$Journal, 
                                    .data$year) %>% 
  dplyr::summarise(freq = length(.data$year), TC = sum(.data$TC), 
                   TCpY = sum(.data$TCpY), .groups = "drop")
df2_journal_husk$Journal <- factor(df2_journal_husk$Journal, levels = SO[1:k_husk])
x <- c(0.5, 1.5 * k_husk/10)
y <- c(min(df_journal$year), min(df_journal$year) + diff(range(df_journal$year)) * 
         0.125)
```


```{r}
g_journal_husk <-
  ggplot(df2_journal_husk, 
         aes(x = Journal, 
             y = year, 
             text = paste("Journal: ",
                          Journal, "\nYear: ",
                          year, "\nN. of Articles: ",
                          freq, "\nTotal Citations per Year: ",
                          round(TCpY,
                                2)
             )
         )
  ) + 
  geom_point(aes(alpha = TCpY, 
                 size = freq), 
             color = "dodgerblue4") + 
  scale_size(range = c(2, 6)) + 
  scale_alpha(range = c(0.3, 1)) + 
  scale_y_continuous(breaks = seq(min(df2_journal_husk$year), 
                                  max(df2_journal_husk$year), 
                                  by = 2)) + 
  guides(size = guide_legend(order = 1,
                             "N.Articles"), 
         alpha = guide_legend(order = 2, 
                              "TC per Year")) + 
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "Husk Top-Journals' Production over the Time", 
       x = "Journal", y = "Year") + 
  geom_line(data = df2_journal_husk, 
            aes(x = Journal, y = year, group = Journal),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(df2_journal_husk$Journal))) + 
  coord_flip()
```

```{r}
g_journal_husk
```

### Pulp

```{r}
M_journal_pulp <- 
  data_tidied |> 
  rename("TI" = title) |> 
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "pulp") |> 
  select(SO, PY, TC) |> 
  mutate(TCpY = TC/(2021 - PY + 1)) |> 
  add_count(SO, PY) |> 
  rename(freq = n)
```


```{r}
g_journal_pulp <- 
  M_journal_pulp |> 
  ggplot(aes(y = PY, 
             x = SO,
             text = paste("Journal: ",
                          SO, "\nYear: ",
                          PY, "\nN. of Articles: ",
                          freq, "\nTotal Citations per Year: ",
                          round(TCpY,
                                2)))) + 
  geom_point(aes(alpha = M_journal_pulp |> 
                   pull(TCpY),
                 size = freq), 
             color = "dodgerblue4") +
  scale_size(range = c(2, 6)) +
  scale_alpha(range= c(0.3, 1)) +
  scale_y_continuous(breaks = seq(min(M_journal_pulp |> 
                                        pull(PY)),
                                  max(M_journal_pulp |> 
                                        pull(PY)),
                                  by = 2)) +
  guides(size = guide_legend(order = 1,
                             "N. Articles"),
         alpha = guide_legend(order = 2, 
                              "TC per year")) +
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "pulp Top-Journals' Production over the Time", 
       x = "Journal", y = "Year") + 
  geom_line(data = M_journal_pulp, 
            aes(x = SO, y = PY, group = SO),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(M_journal_pulp$PY))) + 
  coord_flip()
```

```{r}
g_journal_pulp
```

### Silverskin

```{r}
M_journal_silverskin <- 
  data_tidied |> 
  rename("TI" = title) |> 
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "silverskin") |> 
  select(SO, PY, TC) |> 
  mutate(TCpY = TC/(2021 - PY + 1)) |> 
  add_count(SO, PY) |> 
  rename(freq = n)
```


```{r}
g_journal_silverskin <- 
  M_journal_silverskin |> 
  ggplot(aes(y = PY, 
             x = SO,
             text = paste("Journal: ",
                          SO, "\nYear: ",
                          PY, "\nN. of Articles: ",
                          freq, "\nTotal Citations per Year: ",
                          round(TCpY,
                                2)))) + 
  geom_point(aes(alpha = M_journal_silverskin |> 
                   pull(TCpY),
                 size = freq), 
             color = "dodgerblue4") +
  scale_size(range = c(2, 6)) +
  scale_alpha(range= c(0.3, 1)) +
  scale_y_continuous(breaks = seq(min(M_journal_pulp |> 
                                        pull(PY)),
                                  max(M_journal_pulp |> 
                                        pull(PY)),
                                  by = 2)) +
  guides(size = guide_legend(order = 1,
                             "N. Articles"),
         alpha = guide_legend(order = 2, 
                              "TC per year")) +
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "Silverskin Top-Journals' Production over the Time", 
       x = "Journal", y = "Year") + 
  geom_line(data = M_journal_silverskin, 
            aes(x = SO, y = PY, group = SO),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(M_journal_silverskin$PY))) + 
  coord_flip()
```

```{r}
g_journal_silverskin
```

### Spent Coffee Ground

```{r}
M_journal_spent_coffee_ground <- 
  data_tidied |> 
  rename("TI" = title) |> 
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "spent_coffee_grounds") |> 
  select(SO, PY, TC) |> 
  mutate(TCpY = TC/(2021 - PY + 1)) |> 
  add_count(SO, PY) |> 
  rename(freq = n)
```


```{r}
g_journal_spent_coffee_ground <- 
  M_journal_spent_coffee_ground |> 
  ggplot(aes(y = PY, 
             x = SO,
             text = paste("Journal: ",
                          SO, "\nYear: ",
                          PY, "\nN. of Articles: ",
                          freq, "\nTotal Citations per Year: ",
                          round(TCpY,
                                2)))) + 
  geom_point(aes(alpha = M_journal_spent_coffee_ground |> 
                   pull(TCpY),
                 size = freq), 
             color = "dodgerblue4") +
  scale_size(range = c(2, 6)) +
  scale_alpha(range= c(0.3, 1)) +
  scale_y_continuous(breaks = seq(min(M_journal_spent_coffee_ground |> 
                                        pull(PY)),
                                  max(M_journal_spent_coffee_ground |> 
                                        pull(PY)),
                                  by = 2)) +
  guides(size = guide_legend(order = 1,
                             "N. Articles"),
         alpha = guide_legend(order = 2, 
                              "TC per year")) +
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "Silverskin Top-Journals' Production over the Time", 
       x = "Journal", y = "Year") + 
  geom_line(data = M_journal_spent_coffee_ground, 
            aes(x = SO, y = PY, group = SO),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(M_journal_spent_coffee_ground$PY))) + 
  coord_flip()
```

```{r}
g_journal_spent_coffee_ground
```

## 3.1.3 Author analysis

### Husk

```{r}
husk_authors_top <- 
  data_tidied |>
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "husk") |> 
  separate_rows(AU, sep = ";") |> 
  count(AU, sort = TRUE)

husk_authors <- 
  data_tidied |>
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "husk") |> 
  separate_rows(AU, sep = ";") |>
  select(AU, PY, TC) |> 
  group_by(AU, PY) |> 
  add_count(AU, PY) |> 
  summarise(TC_total = sum(TC),
            freq = unique(n),
            .groups = "drop") |> 
  mutate(TCpY = TC_total/(2021 - PY + 1)) 
```

```{r}
husk_authors <- data_tidied |> 
  rename("TI" = title) |> 
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "husk")

k <- 10
husk_authors$TC <- as.numeric(husk_authors$TC)
data_tidied$PY <- as.numeric(data_tidied$PY)
data_tidied <- data_tidied[!is.na(data_tidied$PY), ]
AU_husk <- names(tableTag(husk_authors, "AU"))
k <- min(k, length(AU_husk))
AU_husk <- AU_husk[1:k]
df_husk_authors <- 
  data.frame(Author = "NA", 
             year = NA, 
             TI = "NA", 
             SO = "NA", 
             DOI = "NA", 
             TC = NA, 
             TCpY = NA, 
             stringsAsFactors = FALSE)
Y <- as.numeric(substr(Sys.time(), 1, 4))
if (!("DI" %in% names(husk_authors))) {
  husk_authors$DI = "NA"
}
for (i in 1:length(AU_husk)) {
  ind <- which(regexpr(AU_husk[i], husk_authors$AU) > -1)
  TCpY <- husk_authors$TC[ind]/(Y - husk_authors$PY[ind] + 1)
  dfAU <- data.frame(Author = rep(AU_husk[i], length(ind)), 
                     year = husk_authors$PY[ind], 
                     TI = husk_authors$TI[ind], 
                     SO = husk_authors$SO[ind], 
                     DOI = husk_authors$DI[ind], 
                     TC = husk_authors$TC[ind], 
                     TCpY = TCpY, 
                     stringsAsFactors = TRUE)
  df_husk_authors <- rbind(df_husk_authors, dfAU)
}
df_husk_authors <- df_husk_authors[-1, ]
df2_husk_authors <- dplyr::group_by(df_husk_authors, 
                                    .data$Author, 
                                    .data$year) %>% 
  dplyr::summarise(freq = length(.data$year), 
                   TC = sum(.data$TC), 
                   TCpY = sum(.data$TCpY))
df2_husk_authors <- as.data.frame(df2_husk_authors)
df2_husk_authors$Author <- factor(df2_husk_authors$Author, levels = AU_husk[1:k])
x <- c(0.5, 1.5 * k/10)
y <- c(min(df$year), min(df$year) + diff(range(df2$year)) * 
         0.125)
```


```{r}
husk_authors_plot <- 
  ggplot(df2_husk_authors, 
         aes(x = Author, 
             y = year, 
             text = paste("Author: ",
                          Author, "\nYear: ",
                          year, "\nN. of Articles: ",
                          freq, "\nTotal Citations per Year: ",
                          round(TCpY,
                                2)
             )
         )
  ) + 
  geom_point(aes(alpha = TCpY, 
                 size = freq), 
             color = "dodgerblue4") + 
  scale_size(range = c(2, 6)) + 
  scale_alpha(range = c(0.3, 1)) + 
  scale_y_continuous(breaks = seq(min(df2_husk_authors$year), 
                                  max(df2_husk_authors$year), 
                                  by = 2)) + 
  guides(size = guide_legend(order = 1,
                             "N.Articles"), 
         alpha = guide_legend(order = 2, 
                              "TC per Year")) + 
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "Top-Authors' Production over the Time", 
       x = "Author", y = "Year") + 
  geom_line(data = df2_husk_authors, 
            aes(x = Author, y = year, group = Author),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(df2_husk_authors$Author))) + 
  coord_flip()
```

### Pulp

```{r}
pulp_authors <- data_tidied |> 
  rename("TI" = title) |> 
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "pulp")

k <- 10
pulp_authors$TC <- as.numeric(pulp_authors$TC)
data_tidied$PY <- as.numeric(data_tidied$PY)
data_tidied <- data_tidied[!is.na(data_tidied$PY), ]
AU_pulp <- names(tableTag(pulp_authors, "AU"))
k <- min(k, length(AU_pulp))
AU_pulp <- AU_pulp[1:k]
df_pulp_authors <- 
  data.frame(Author = "NA", 
             year = NA, 
             TI = "NA", 
             SO = "NA", 
             DOI = "NA", 
             TC = NA, 
             TCpY = NA, 
             stringsAsFactors = FALSE)
Y <- as.numeric(substr(Sys.time(), 1, 4))
if (!("DI" %in% names(pulp_authors))) {
  pulp_authors$DI = "NA"
}
for (i in 1:length(AU_pulp)) {
  ind <- which(regexpr(AU_pulp[i], pulp_authors$AU) > -1)
  TCpY <- pulp_authors$TC[ind]/(Y - pulp_authors$PY[ind] + 1)
  dfAU <- data.frame(Author = rep(AU_pulp[i], length(ind)), 
                     year = pulp_authors$PY[ind], 
                     TI = pulp_authors$TI[ind], 
                     SO = pulp_authors$SO[ind], 
                     DOI = pulp_authors$DI[ind], 
                     TC = pulp_authors$TC[ind], 
                     TCpY = TCpY, 
                     stringsAsFactors = TRUE)
  df_pulp_authors <- rbind(df_pulp_authors, dfAU)
}
df_pulp_authors <- df_pulp_authors[-1, ]
df2_pulp_authors <- dplyr::group_by(df_pulp_authors, 
                                    .data$Author, 
                                    .data$year) %>% 
  dplyr::summarise(freq = length(.data$year), 
                   TC = sum(.data$TC), 
                   TCpY = sum(.data$TCpY))
df2_pulp_authors <- as.data.frame(df2_pulp_authors)
df2_pulp_authors$Author <- factor(df2_pulp_authors$Author, levels = AU_pulp[1:k])
x <- c(0.5, 1.5 * k/10)
y <- c(min(df$year), min(df$year) + diff(range(df2$year)) * 
         0.125)
```


```{r}
pulp_authors_plot <- 
  ggplot(df2_pulp_authors, 
         aes(x = Author, 
             y = year, 
             text = paste("Author: ",
                          Author, "\nYear: ",
                          year, "\nN. of Articles: ",
                          freq, "\nTotal Citations per Year: ",
                          round(TCpY,
                                2)
             )
         )
  ) + 
  geom_point(aes(alpha = TCpY, 
                 size = freq), 
             color = "dodgerblue4") + 
  scale_size(range = c(2, 6)) + 
  scale_alpha(range = c(0.3, 1)) + 
  scale_y_continuous(breaks = seq(min(df2_pulp_authors$year), 
                                  max(df2_pulp_authors$year), 
                                  by = 2)) + 
  guides(size = guide_legend(order = 1,
                             "N.Articles"), 
         alpha = guide_legend(order = 2, 
                              "TC per Year")) + 
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "Top-Authors' Production over the Time", 
       x = "Author", y = "Year") + 
  geom_line(data = df2_pulp_authors, 
            aes(x = Author, y = year, group = Author),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(df2_pulp_authors$Author))) + 
  coord_flip()
```

### spent_coffee_grounds

```{r}
spent_coffee_grounds_authors <- data_tidied |> 
  rename("TI" = title) |> 
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "spent_coffee_grounds")

k <- 10
spent_coffee_grounds_authors$TC <- as.numeric(spent_coffee_grounds_authors$TC)
data_tidied$PY <- as.numeric(data_tidied$PY)
data_tidied <- data_tidied[!is.na(data_tidied$PY), ]
AU_spent_coffee_grounds <- names(tableTag(spent_coffee_grounds_authors, "AU"))
k <- min(k, length(AU_spent_coffee_grounds))
AU_spent_coffee_grounds <- AU_spent_coffee_grounds[1:k]
df_spent_coffee_grounds_authors <- 
  data.frame(Author = "NA", 
             year = NA, 
             TI = "NA", 
             SO = "NA", 
             DOI = "NA", 
             TC = NA, 
             TCpY = NA, 
             stringsAsFactors = FALSE)
Y <- as.numeric(substr(Sys.time(), 1, 4))
if (!("DI" %in% names(spent_coffee_grounds_authors))) {
  spent_coffee_grounds_authors$DI = "NA"
}
for (i in 1:length(AU_spent_coffee_grounds)) {
  ind <- which(regexpr(AU_spent_coffee_grounds[i], spent_coffee_grounds_authors$AU) > -1)
  TCpY <- spent_coffee_grounds_authors$TC[ind]/(Y - spent_coffee_grounds_authors$PY[ind] + 1)
  dfAU <- data.frame(Author = rep(AU_spent_coffee_grounds[i], length(ind)), 
                     year = spent_coffee_grounds_authors$PY[ind], 
                     TI = spent_coffee_grounds_authors$TI[ind], 
                     SO = spent_coffee_grounds_authors$SO[ind], 
                     DOI = spent_coffee_grounds_authors$DI[ind], 
                     TC = spent_coffee_grounds_authors$TC[ind], 
                     TCpY = TCpY, 
                     stringsAsFactors = TRUE)
  df_spent_coffee_grounds_authors <- rbind(df_spent_coffee_grounds_authors, dfAU)
}
df_spent_coffee_grounds_authors <- df_spent_coffee_grounds_authors[-1, ]
df2_spent_coffee_grounds_authors <- dplyr::group_by(df_spent_coffee_grounds_authors, 
                                                    .data$Author, 
                                                    .data$year) %>% 
  dplyr::summarise(freq = length(.data$year), 
                   TC = sum(.data$TC), 
                   TCpY = sum(.data$TCpY))
df2_spent_coffee_grounds_authors <- as.data.frame(df2_spent_coffee_grounds_authors)
df2_spent_coffee_grounds_authors$Author <- factor(df2_spent_coffee_grounds_authors$Author, levels = AU_spent_coffee_grounds[1:k])
x <- c(0.5, 1.5 * k/10)
y <- c(min(df$year), min(df$year) + diff(range(df2$year)) * 
         0.125)
```


```{r}
spent_coffee_grounds_authors_plot <- 
  ggplot(df2_spent_coffee_grounds_authors, 
         aes(x = Author, 
             y = year, 
             text = paste("Author: ",
                          Author, "\nYear: ",
                          year, "\nN. of Articles: ",
                          freq, "\nTotal Citations per Year: ",
                          round(TCpY,
                                2)
             )
         )
  ) + 
  geom_point(aes(alpha = TCpY, 
                 size = freq), 
             color = "dodgerblue4") + 
  scale_size(range = c(2, 6)) + 
  scale_alpha(range = c(0.3, 1)) + 
  scale_y_continuous(breaks = seq(min(df2_spent_coffee_grounds_authors$year), 
                                  max(df2_spent_coffee_grounds_authors$year), 
                                  by = 2)) + 
  guides(size = guide_legend(order = 1,
                             "N.Articles"), 
         alpha = guide_legend(order = 2, 
                              "TC per Year")) + 
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "Top-Authors' Production over the Time", 
       x = "Author", y = "Year") + 
  geom_line(data = df2_spent_coffee_grounds_authors, 
            aes(x = Author, y = year, group = Author),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(df2_spent_coffee_grounds_authors$Author))) + 
  coord_flip()
```

### silverskin

```{r}
silverskin_authors <- data_tidied |> 
  rename("TI" = title) |> 
  separate_rows(byproduct, sep = ", ") |> 
  filter(byproduct %in% "silverskin")

k <- 10
silverskin_authors$TC <- as.numeric(silverskin_authors$TC)
data_tidied$PY <- as.numeric(data_tidied$PY)
data_tidied <- data_tidied[!is.na(data_tidied$PY), ]
AU_silverskin <- names(tableTag(silverskin_authors, "AU"))
k <- min(k, length(AU_silverskin))
AU_silverskin <- AU_silverskin[1:k]
df_silverskin_authors <- 
  data.frame(Author = "NA", 
             year = NA, 
             TI = "NA", 
             SO = "NA", 
             DOI = "NA", 
             TC = NA, 
             TCpY = NA, 
             stringsAsFactors = FALSE)
Y <- as.numeric(substr(Sys.time(), 1, 4))
if (!("DI" %in% names(silverskin_authors))) {
  silverskin_authors$DI = "NA"
}
for (i in 1:length(AU_silverskin)) {
  ind <- which(regexpr(AU_silverskin[i], silverskin_authors$AU) > -1)
  TCpY <- silverskin_authors$TC[ind]/(Y - silverskin_authors$PY[ind] + 1)
  dfAU <- data.frame(Author = rep(AU_silverskin[i], length(ind)), 
                     year = silverskin_authors$PY[ind], 
                     TI = silverskin_authors$TI[ind], 
                     SO = silverskin_authors$SO[ind], 
                     DOI = silverskin_authors$DI[ind], 
                     TC = silverskin_authors$TC[ind], 
                     TCpY = TCpY, 
                     stringsAsFactors = TRUE)
  df_silverskin_authors <- rbind(df_silverskin_authors, dfAU)
}
df_silverskin_authors <- df_silverskin_authors[-1, ]
df2_silverskin_authors <- dplyr::group_by(df_silverskin_authors, 
                                          .data$Author, 
                                          .data$year) %>% 
  dplyr::summarise(freq = length(.data$year), 
                   TC = sum(.data$TC), 
                   TCpY = sum(.data$TCpY))
df2_silverskin_authors <- as.data.frame(df2_silverskin_authors)
df2_silverskin_authors$Author <- factor(df2_silverskin_authors$Author, levels = AU_silverskin[1:k])
x <- c(0.5, 1.5 * k/10)
y <- c(min(df$year), min(df$year) + diff(range(df2$year)) * 
         0.125)
```


```{r}
silverskin_authors_plot <- 
  ggplot(df2_silverskin_authors, 
         aes(x = Author, 
             y = year, 
             text = paste("Author: ",
                          Author, "\nYear: ",
                          year, "\nN. of Articles: ",
                          freq, "\nTotal Citations per Year: ",
                          round(TCpY,
                                2)
             )
         )
  ) + 
  geom_point(aes(alpha = TCpY, 
                 size = freq), 
             color = "dodgerblue4") + 
  scale_size(range = c(2, 6)) + 
  scale_alpha(range = c(0.3, 1)) + 
  scale_y_continuous(breaks = seq(min(df2_silverskin_authors$year), 
                                  max(df2_silverskin_authors$year), 
                                  by = 2)) + 
  guides(size = guide_legend(order = 1,
                             "N.Articles"), 
         alpha = guide_legend(order = 2, 
                              "TC per Year")) + 
  theme(legend.position = "right", text = element_text(color = "#444444"), 
        panel.background = element_rect(fill = "gray97"), 
        panel.grid.minor = element_line(color = "#FFFFFF"), 
        panel.grid.major = element_line(color = "#FFFFFF"), 
        plot.title = element_text(size = 24), 
        axis.title = element_text(size = 14, 
                                  color = "#555555"), 
        axis.title.y = element_text(vjust = 1,
                                    angle = 90, 
                                    face = "bold"), 
        axis.title.x = element_text(hjust = 0.95,
                                    face = "bold"), 
        axis.text.x = element_text(face = "bold", 
                                   angle = 90), 
        axis.text.y = element_text(face = "bold")) + 
  labs(title = "Top-Authors' Production over the Time", 
       x = "Author", y = "Year") + 
  geom_line(data = df2_silverskin_authors, 
            aes(x = Author, y = year, group = Author),
            size = 1, color = "firebrick", alpha = 0.3) + 
  scale_x_discrete(limits = rev(levels(df2_silverskin_authors$Author))) + 
  coord_flip()
```

## 3.1.4 Country Analysis

```{r}
husk_country <- 
  data_tidied |> 
  filter(str_detect(byproduct, 
                    pattern = "husk")) |> 
  biblioAnalysis(sep = "; ") |> 
  plot()

husk_country_plot <- 
  husk_country$MostProdCountries +
  labs(title = "husk")

pulp_country <- 
  data_tidied |> 
  filter(str_detect(byproduct, 
                    pattern = "pulp")) |> 
  biblioAnalysis(sep = "; ") |> 
  plot()

pulp_country_plot <- 
  pulp_country$MostProdCountries +
  labs(title = "pulp")

silverskin_country <- 
  data_tidied |> 
  filter(str_detect(byproduct, 
                    pattern = "silverskin")) |> 
  biblioAnalysis(sep = "; ") |> 
  plot()

silverskin_country_plot <- 
  silverskin_country$MostProdCountries +
  labs(title = "silverskin")

spent_coffee_ground_country <- 
  data_tidied |> 
  filter(str_detect(byproduct, 
                    pattern = "spent_coffee_grounds")) |> 
  biblioAnalysis(sep = "; ") |> 
  plot()

spent_coffee_ground_country_plot <- 
  spent_coffee_ground_country$MostProdCountries +
  labs(title = "spent_coffee_grounds")

country_scientific_production <- 
  ggarrange(
    ggarrange(spent_coffee_ground_country_plot, silverskin_country_plot, 
              ncol = 2, labels = c("a", "b"), 
              align = "h",widths = c(1.5,2)), 
    ggarrange(pulp_country_plot, husk_country_plot,
              ncol = 2, labels = c("c", "d"), 
              align = "h",widths = c(1.5,2)), 
    nrow = 2
  ) 

country_scientific_production
```

Add one in general?

# 3.2 Academic networks of Coffee By-products 

## 3.2.1 Author Cocitation Network

```{r}
edgelist_scopus <- 
  data_tidied |>
  filter(str_detect(database, 
                    "Scopus")) |> 
  select(SR, CR, database, SO) |> 
  separate_rows(CR, sep = "; ") |> 
  mutate(SR_TOS = str_extract(SR, one_or_more(WRD) %R%
                                SPC %R% one_or_more(WRD) %R%
                                "," %R% SPC %R%
                                one_or_more(DGT) %R% ","),
         SR_TOS = str_c(SR_TOS, " ", SO)) %>%
  mutate(ID_TOS =str_extract(SR, ".*,")) |> 
  select(ID_TOS, CR) |> 
  mutate(lastname = sub("\\., .*", "", CR),
         lastname = sub(",", "", lastname),
         lastname = sub("\\.", "", lastname),
         year = str_extract(CR, "\\(([0-9]{4})\\)"),
         year = str_remove_all(year, "\\(|\\)")) |> 
  filter(!grepl(pattern = "[():[:digit:]]", lastname),
         str_length(year) == 4) |> 
  mutate(CR = paste0(lastname, ", ", year, ",")) %>%
  select(ID_TOS, CR)

edgelist_wos <- 
  data_tidied |>
  filter(str_detect(database, 
                    "wos")) |> 
  select(SR, CR, database, SO) |> 
  separate_rows(CR, sep = ";") |> 
  mutate(ID_TOS = str_extract(SR, ".*,")) |> 
  mutate(CR = sub("^(\\S*\\s+\\S+\\s+\\S+).*", # removing strings after second comma
                  "\\1", CR)) %>%
  select(ID_TOS, CR) %>%
  na.omit() %>%
  unique() 

edgelist <- 
  edgelist_scopus |> 
  bind_rows(edgelist_wos) |> 
  mutate(CR = str_replace_all(CR, 
                              pattern = "\\.", 
                              replacement = ""))

byproducts_graph_raw <- 
  edgelist |> 
  graph.data.frame(directed = TRUE) |> 
  simplify()

byproducts_graph_cleaned <- 
  delete.vertices(byproducts_graph_raw, 
                  which(degree(byproducts_graph_raw, 
                               mode = "in") == 1 &
                          which(degree(byproducts_graph_raw, 
                                       mode = "out") == 0)))

giant.component <- function(graph) {
  cl <- igraph::clusters(graph)
  igraph::induced.subgraph(graph, which(cl$membership == which.max(cl$csize)))
}

byproducts_graph <- 
  giant.component(byproducts_graph_cleaned)

subareas <- 
  byproducts_graph |> 
  as.undirected(mode = "each") |> 
  cluster_louvain()

byproducts_graph_subareas <- 
  byproducts_graph |> 
  set_vertex_attr(name = "sub_area",
                  value = membership(subareas))

write.graph(byproducts_graph_subareas, 
            here("output", 
                 "byproducts_citation_network.graphml" ), 
            format = "graphml")
```

Identifying names in Scopus and WoS

```{r}
data_tidied_scopus <- 
  data_tidied |> 
  filter(database %in% "Scopus") |> 
  mutate(ID_TOS = str_extract(SR, ".*,")) 

data_tidied_scopus_ref <- 
  data_tidied_scopus |> 
  select(CR) |> 
  separate_rows(CR, sep = "; ") |> 
  mutate(lastname = sub("\\., .*", "", CR),
         lastname = sub(",", "", lastname),
         lastname = sub("\\.", "", lastname),
         year = str_extract(CR, "\\(([0-9]{4})\\)"),
         year = str_remove_all(year, "\\(|\\)")) |> 
  # filter(!grepl(pattern = "[():[:digit:]]", lastname),
         # str_length(year) == 4) %>%
  mutate(lastname = str_replace(lastname, 
                                pattern = "\\.", 
                                replacement = ""),
         ID_TOS = paste0(lastname, ", ", year, ",")) |> 
  select(ID_TOS, CR)

# Only 1!

edgelist <- tibble(Source = as.character(),
                   Target = as.character())

for (i in 1:length(data_tidied_scopus_ref$CR)) {
  
  df_1 <- data_tidied_scopus_ref |> 
    select(CR) |> 
    slice(i) |>
    mutate(authors_2 = str_remove(CR, 
                                "\\([0-9]{4}\\) .*"),
           authors_1 = str_extract(authors_2,
                                 ".*\\.,"),
           authors = str_replace_all(authors_1,
                                     "\\.", 
                                     replacement = "")) |> 
    select(authors) |> 
    separate_rows(authors, sep = ", ") |> 
    mutate(authors = str_replace(authors, ",", "")) |>
    pull() |> 
    rollapply(2, by=2, c) |> 
    as_tibble() |> 
    unite(authors, sep = " ") |> 
    mutate(authors = str_replace(authors, "(?<= [[:alpha:]]).*", ""))
  
  if (dim(df_1)[1] >= 2) {
    
    df_2 <- df_1 |> 
      pull() |> 
      combn(2, simplify = FALSE) |> 
      as_tibble(.name_repair = "minimal") |> 
      t() |> 
      data.frame() |> 
      dplyr::rename(Source = 1, 
             Target = 2)
    
    edgelist <- edgelist |> 
      bind_rows(df_2)
    
  }
}

edgelist_scopus_ref <- edgelist |> 
  filter(!str_detect(Source, "[0-9]"),
         !str_detect(Target, "[0-9]"))

```

Edge list of main papers 

```{r}
data_tidied_scopus_main <- 
  data_tidied |> 
  filter(database %in% "Scopus") |> 
  select(SR, AU) |> 
  separate_rows(AU, sep = ";")

edgelist_main <- tibble(Source = as.character(),
                        Target = as.character())

for (i in data_tidied_scopus_main$SR) {
  
  df_1 <- data_tidied_scopus_main |> 
    filter(SR %in% i)
  
  if (dim(df_1)[1] >= 2) {
    
    df_2 <- df_1 |> 
      select(AU) |> 
      pull() |> 
      combn(2, simplify = FALSE) |> 
      as_tibble(.name_repair = "minimal") |> 
      t() |> 
      data.frame() |> 
      rename(Source = 1, 
             Target = 2)
    
    edgelist_main <- edgelist_main |> 
      bind_rows(df_2)
    
  }
  
}
```

Merging both edge lists 

```{r}
edgelist_total_scopus <- 
  edgelist_main |>
  bind_rows(edgelist_scopus_ref)

edgelist_total_scopus |> count(Source, Target)
```

Creating the graph

```{r}
author_cocitation_network_scopus <- 
  graph.data.frame(edgelist_total, 
                   directed = FALSE) |> 
  simplify()

author_cocitation_network_scopus |> 
  summary()
```


WoS

```{r}
DOI <- 
  data_tidied |> 
  filter(database %in% "wos") |> 
  select(CR) |> 
  separate_rows(CR, sep = ";") |> # 1650 rows
  filter(str_detect(CR, "DOI"))  |>   # 1300 rows
  mutate(DOI = str_remove(CR, ".*DOI ")) |> 
  distinct(DOI)    # 1039 rows

  
  
  ##########################################################################
#### Extracci?n de la informaci?n de los art?culos de las referencias ####
##########################################################################

references <- data.frame(DI = character(), 
                         PU = character(), 
                         SO = character(), 
                         J9 = character(), 
                         PD = character(), 
                         PY = character(), 
                         TI = character(), 
                         AF = character(), 
                         stringsAsFactors = FALSE)

authors <- data.frame(doi = character(), 
                      author = character(), 
                      year = character(), 
                      month = character(), 
                      stringsAsFactors = FALSE)

for (i in DOI$DOI) {
  doi <- i
  url <- paste0("http://api.crossref.org/works/", doi, ".xml")
  xml_data_1 = try(xmlParse(url), silent = TRUE);
  if (class(xml_data_1) == "try-error") {
    next
  } else  {
    xml_data_2 <- xmlToList(xml_data_1)
    
    notfound =try(as.list(xml_data_2[["query_result"]][["body"]][["query"]][["doi"]][[".attrs"]]) == "journal_article", silent = TRUE);
    if (class(notfound) == "try-error"){
      next
    }else{
      
      if (as.list(xml_data_2[["query_result"]][["body"]][["query"]][["doi"]][[".attrs"]]) == "journal_article"){
        
        # PUBLISHER-NAME
        
        
        if (is.null(xml_data_2[["query_result"]][["body"]][["query"]][["crm-item"]])){
          PU <- as.character(NA) 
        } else {
          
          publisher0 <- as.list(xml_data_2[["query_result"]][["body"]][["query"]][["crm-item"]])
          publisher <- data.frame(publisher0)
          if(nrow(publisher) == 0){
            PU <- as.character(NA)
          }else{
            PU <- as.character(publisher$text[1])
          }
        }
        
        # JOURNAL FULL TITLE 
        
        
        if (is.null(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_metadata"]][["full_title"]])){
          SO <- as.character(NA) 
        } else {
          
          journal0 <- as.list(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_metadata"]][["full_title"]])
          journal <- data.frame(journal0)
          if(nrow(journal) == 0){
            SO <- as.character(NA)
          }else{
            SO <- as.character(journal[1,1])
          }
        }
        
        # JOURNAL ABBREV TITLE 
        
        
        if (is.null(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_metadata"]][["abbrev_title"]])){
          J9 <- as.character(NA) 
        } else {
          
          journal0 <- as.list(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_metadata"]][["abbrev_title"]])
          journal <- data.frame(journal0)
          if(nrow(journal) == 0){
            J9 <- as.character(NA)
          }else{
            J9 <- as.character(journal[1,1])
          }
        }
        
        # MONTH
        
        
        if (is.null(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_issue"]][["publication_date"]][["month"]])){
          PD <- as.character(NA) 
        } else {
          
          month0 <- as.list(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_issue"]][["publication_date"]][["month"]])
          month <- data.frame(month0)
          if(nrow(month) == 0){
            PD <- as.character(NA)
          }else{
            PD <- as.character(month[1,1]) 
          }
        }
        
        # YEAR
        
        
        if (is.null(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_issue"]][["publication_date"]][["year"]])){
          PY <- as.character(NA) 
        } else {
          
          Year0 <- as.list(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_issue"]][["publication_date"]][["year"]])
          Year <- data.frame(Year0)
          if(nrow(Year) == 0){
            PY <- as.character(NA)
          }else{
            PY <- as.character(Year[1,1]) 
          }
        }
        
        # TITLE
        
        
        if (is.null(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_article"]][["titles"]][["title"]])){
          TI <- as.character(NA) 
        } else {
          
          title0 <- as.list(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_article"]][["titles"]][["title"]])
          title <- try(data.frame(title0), silent = TRUE);
          
          if(class(title) == "try-error"){
            titlex <- try(ldply(title0, data.frame), silent = TRUE);
            if(class(titlex) == "try-error"){
              TI <- as.character(NA)
            }else{
              TI0 <- as.character(titlex[1,2])
              TI <- trimws(TI0)
            }
          }else{
            if(nrow(title) == 0){
              TI <- as.character(NA)
            }else{
              TI <- as.character(title[1,1])
            }
          }
        }
        
        # CONTRIBUTORS
        
        
        if (is.null(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_article"]][["contributors"]]))
        {
          AF <- as.character(NA)
        } else {
          
          author_ref <- as.list(xml_data_2[["query_result"]][["body"]][["query"]][["doi_record"]][["crossref"]][["journal"]][["journal_article"]][["contributors"]])
          
          author_1_ref <- ldply(author_ref, data.frame)
          author_2_ref <- author_1_ref[author_1_ref$.attrs == "author", c(2,3) ]
          
          authorss <- data.frame(doi= doi, author = paste0(author_2_ref$surname, ", ", author_2_ref$given_name), year = PY, month = PD)
          
          authors = rbind(authors, authorss)
          authorss$author <- trim(authorss$author)
          AF <- as.character(paste(authorss$author, collapse = ";   "))
        }
        
        references0 <- data.frame(DI = doi, PU = PU, SO = SO, J9 = J9, PD = PD, PY = PY, TI = TI, AF = AF)
        references = rbind(references, references0) 
        
      }else {
        next}
    }
  }
} 

authors$month <- sub("^[0]+", "", authors$month) # Elimina los ceros a la izquierda en los meses

##########################################################################
#### Separaci?n de los nombres de los autores de los art?culos de WoS ####
##########################################################################

wos_author <- data_tidied |> 
  filter(database %in% "wos") |>
  select(doi, AU) |> 
  separate_rows(AU, sep = ";") |> 
  dplyr::rename(author = AU)

#################################################################
#### Uni?n de los datos de WoS y de las referencias de estos ####
#################################################################

authors$author <- gsub("(?<=, [[:alpha:]]).*", "", authors$author, perl=TRUE)

wos_author_ref <- authors |> 
  mutate(author = str_replace(author, ",", "")) |> 
  select(doi, author)

```


```{r}
###########################
#### Listas de enlaces ####
###########################

# Para art?culos que tienen como m?nimo dos autores

author_1 <- wos_author |> 
  bind_rows(wos_author_ref)

edgelist_wos_authors <- data.frame(Source = character(), 
                                   Target = character(), 
                                   doi = character(), 
                                   stringsAsFactors = FALSE)

table_ids <- table(author_1$doi)
table_ids_0 <- data.frame(table_ids)
table_ids_1 <- table_ids_0[table_ids_0$Freq >= 2,]
list_ids_1 <- unique(table_ids_1$Var1)

for (i in list_ids_1) {
  df_1 = author_1[author_1$doi == i,]
  df_2 = combn(df_1$author, 2, simplify = FALSE)
  df_3 = data.frame((t(data.frame(df_2))), i)
  colnames(df_3) = c("Source", "Target", "doi")
  edgelist_wos_authors = rbind(edgelist_wos_authors, df_3)
}
```


```{r}
author_cocitation_network_wos <- 
  graph.data.frame(edgelist_wos_authors, directed = FALSE) |> 
  simplify()

author_cocitation_network_wos |> summary()
```


Merging both datasets 

```{r}
edgelist_author_cocitation_wos_scopus <- edgelist_wos_authors |> 
  select(-doi) |> 
  bind_rows(edgelist_total_scopus)

author_cocitation_byproducts <- 
  graph.data.frame(edgelist_author_cocitation_wos_scopus, 
                   directed = FALSE)
  
author_cocitation_byproducts |> summary()
```

We created a unweighted graph!!! We didn't know how to do it in R :-(

This is the result from gephi

```{r}
author_cocitation_byproducts_gephi <- 
  igraph::read_graph(file = "output/author_cocitation_weighted.graphml", 
             format = "graphml")

author_cocitation_byproducts_gephi |> summary()
```



## 3.2.2 Author Co-citation Network

```{r}
author_co_citation_tags <- 
  metaTagExtraction(data_tidied |> slice(1:4), 
                    Field = "CR_AU", 
                    sep = ";")
author_co_citation_network <- 
  biblioNetwork(data.frame(author_co_citation_tags), 
                analysis = "co-citation", 
                network = "authors", 
                sep = ";")

net=networkPlot(author_co_citation_network, n = 200, 
                Title = "Author Co-citation Network", 
                type = "fruchterman", 
                size=T,
                remove.multiple=FALSE, 
                labelsize=0.7,
                edgesize = 5,
                cluster = 'louvain')

author_co_citation_graph <- 
  graph_from_adjacency_matrix(adjmatrix = author_co_citation_network, 
                              mode = "undirected", 
                              weighted = TRUE) |> 
  simplify()

```

Undertanding more... 

```{r}
dummy_co_citation <- 
  tibble()
```


The results are scattered in author collaboration network.  

## 3.2.2 Journal co-Citation Network

Scopus

```{r}
data_tidied |> 
  filter(database %in% "Scopus") |> 
  select(SO) |> 
  slice(1) |> 
  pull()
```

```{r}
scopus_ref_journal <- 
  data_tidied |> 
  filter(database %in% "Scopus") |> 
  select(CR) |> 
  separate_rows(CR, sep = ";") |> 
  mutate(SO = str_remove(CR,
                         ".*\\([0-9]{4}\\)")) |> 
  mutate(SO = str_remove(string = SO, ",.*")) |> 
  mutate(SO =str_trim(string = SO, side = "both")) |> 
  filter(SO != "") |> 
  mutate(SO = str_remove_all(string = SO, pattern = "\\."))

journals_all_abbr <- 
  journalabbr::abbrTable |> 
  select(journal, journal_abbr) |> 
  mutate(journal_abbr = str_remove_all(journal_abbr, "\\.")) |> 
  mutate(journal_abbr = str_to_upper(journal_abbr))

journals_all_full <- 
  journalabbr::abbrTable |> 
  select(journal, journal_abbr) |> 
  # mutate(journal = str_remove_all(journal_abbr, "\\.")) |> 
  mutate(journal = str_to_upper(journal))

# Merging abbrevite name to scopus_ref_journal

scopus_ref_journal_1 <- 
  scopus_ref_journal |> 
  left_join(journals_all,by = c("SO" = "journal_abbr"))

scopus_ref_journal_2 <- 
  scopus_ref_journal |> 
  left_join(journals_all_full,by = c("SO" = "journal")) |> 
  # filter(!is.na(journal_abbr)) |> 
  mutate(journal_abbr = str_remove_all(journal_abbr, "\\.")) |> 
  mutate(journal_abbr = str_to_upper(journal_abbr)) |> 
  mutate(journal_abbr = if_else(is.na(journal_abbr), SO, journal_abbr)) |> 
  unique() |> 
  select(CR, SO_REF = journal_abbr) 


# We need abbr from journal to compare with the main dataset (data_tidied)

scopus_journal_citation <- 
  data_tidied |> 
  dplyr::filter(database %in% "Scopus") |> 
  select(SR, CR, JI) |> 
  mutate(JI = str_remove_all(JI, "\\.")) |> 
  separate_rows(CR, sep = ";") |> 
  left_join(scopus_ref_journal_2, by = c("CR" = "CR")) |> 
  select(JI, SO_REF) |>
  filter(!is.na(SO_REF)) |> 
  graph.data.frame(directed = TRUE) |> 
  simplify() |> 
  giant.component()

```

WoS

```{r}

wos_ref_journal <-
  data_tidied |> 
  filter(database %in% "wos") |> 
  select(CR, JI) |> 
  mutate(JI = str_remove_all(JI, "\\.")) |> 
  separate_rows(CR, sep = ";") |> 
  mutate(SO_REF = str_remove(CR, ".*[0-9]{4}, ")) |> 
  mutate(SO_REF = str_remove(SO_REF, ",.*")) |> 
  filter(!str_detect(SO_REF, "[0-9]")) |> 
  select(-CR) |> 
  filter(!is.na(SO_REF))
```

Merging both datasets WoS and Scopus, and creting the graph

```{r}
journal_citation_graph <- 
  scopus_journal_citation |> 
  bind_rows(wos_ref_journal) |> 
  unique() |> 
  graph.data.frame(directed = TRUE) |> 
  simplify() |> 
  giant.component()

journal_citation_graph <- 
  igraph::delete.vertices(journal_citation_graph,
                            which(igraph::degree(journal_citation_graph, mode = "in") == 1 &
                                    igraph::degree(journal_citation_graph, mode = "out") == 0))

# it is not directed?
```


```{r}
journal_cocitation_CR_SO <- 
  metaTagExtraction(M = data_tidied, 
                    Field = "CR_SO", 
                    sep = ";")

journal_cocitation_matrix <- 
  biblioNetwork(M = data.frame(journal_cocitation_CR_SO), 
                analysis = "co-citation", 
                network = "sources",
                sep = ";"
                )

networkPlot(journal_cocitation_matrix, 
            n = 50, 
            Title = "Co-Citation Network", 
            type = "auto", 
            size.cex=TRUE, 
            size=15, 
            remove.multiple=FALSE, 
            labelsize=0.7, 
            edges.min=5)

journal_cocitation_graph <- 
  journal_cocitation |> 
  graph_from_adjacency_matrix(mode = "undirected", weighted = TRUE) |> 
  simplify() |> 
  giant.component()

journal_cocitation_graph_filtered <- 
  journal_cocitation_graph |> 
  delete.vertices(v = which(E(journal_cocitation_graph)$weight > 4))

dummy <- tibble(weights =
                E(journal_cocitation_graph)$weight)
dummy <- get.edges(journal_cocitation_graph,es = E(journal_cocitation_graph)$weight > 4)
```


## 3.2.2 Collab net country

```{r}
M <- metaTagExtraction(data_tidied, 
                       Field = "AU_CO", 
                       sep = ";")

country_collab <- 
  biblioNetwork(data.frame(M), 
                analysis = "collaboration", 
                network = "countries", 
                sep = ";")

net=networkPlot(country_collab, 
                n = dim(country_collab)[1], 
                Title = "Country Collaboration", 
                type = "circle", 
                size=TRUE, 
                remove.multiple=FALSE,
                labelsize=0.7,
                cluster="none")

country_collab_graph <- 
  graph_from_adjacency_matrix(country_collab, 
                              mode = "undirected", 
                              weighted = TRUE) |> 
  simplify()
```

I couldn't create the world map :-( 

## 3.2.3 Collab net universities

```{r}
university_collab <- 
  biblioNetwork(data.frame(data_tidied), 
                analysis = "collaboration", 
                network = "universities", 
                sep = ";")

university_collab_net <- networkPlot(university_collab, 
                                     n = dim(universty_collab)[1], 
                                     Title = "University Collaboration", 
                                     type = "circle", 
                                     size=TRUE, 
                                     remove.multiple=FALSE,
                                     labelsize=0.7,
                                     cluster="none")

# university_collab_graph <- 
#   graph_from_adjacency_matrix(universty_collab_net$graph, 
#                               mode = "undirected", 
#                               weighted = TRUE) |> 
#   simplify()
```

Scattered.... 

## 3.2.4 

## 3.2.5 Co-citation analysis

Author

```{r}
author_co_citation_matrix <- 
  biblioNetwork(data.frame(data_tidied),
                analysis = "co-citation", 
                network = "author", 
                sep = ";")

net=networkPlot(author_co_citation_matrix, 
                n = 80, 
                Title = "Co-Citation Network", 
                type = "fruchterman", 
                size.cex=TRUE, 
                size=20, 
                remove.multiple=FALSE, 
                labelsize=0.7,
                edgesize = 10, 
                edges.min=5)
```

Journal?

https://www.bibliometrix.org/vignettes/Introduction_to_bibliometrix.html

https://bibliometrix.org/documents/bibliometrix_Report.html

# 3.3 Coffee By-products applications

## 3.3.1 Husk

```{r}
data_tidied_husk  <- 
  data_tidied %>% 
  separate_rows(byproduct, sep = ", ") |> 
  separate_rows(categories, sep = ", ") |> 
  filter(str_detect(byproduct, pattern = "husk")) %>% 
  group_by(year,categories) %>% 
  count(categories, sort = TRUE)

data_tidied_husk_plot <- 
  data_tidied_husk %>% 
  arrange(year,categories) %>% 
  mutate(categories = factor(categories)) %>% 
  ggplot(aes(y = categories, x = year, size = n, color= categories)) +
  geom_point(alpha = 1) +
  scale_x_continuous(breaks = seq(min(data_tidied_husk$year),
                                  max(data_tidied_husk$year),
                                  by = 1)) +
  scale_size(name="tags") +
  xlab("Byproducts Applications") +
  ggtitle("Husk applications") +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 10, angle = 45,vjust = 0),
        axis.text.y = element_text(face = "bold", 
                                   size = 10, angle = 0,hjust = 1)) +
  #scale_y_continuous(breaks = seq(2003,2020)) + 
  guides(color = FALSE)

data_tidied_husk_plot
```

## 3.3.2 Pulp

```{r}
data_tidied_pulp  <- 
  data_tidied %>% 
  separate_rows(byproduct, sep = ", ") |> 
  separate_rows(categories, sep = ", ") |> 
  filter(str_detect(byproduct, pattern = "pulp")) %>% 
  group_by(year,categories) %>% 
  count(categories, sort = TRUE)

data_tidied_pulp_plot <- 
  data_tidied_pulp %>% 
  arrange(year,categories) %>% 
  mutate(categories = factor(categories)) %>% 
  ggplot(aes(y = categories, x = year, size = n, color= categories)) +
  geom_point(alpha = 1) +
  scale_x_continuous(breaks = seq(min(data_tidied_pulp$year),
                                  max(data_tidied_pulp$year),
                                  by = 1)) +
  scale_size(name="tags") +
  xlab("Byproducts Applications") +
  ggtitle("Pulp applications") +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 10, angle = 45,vjust = 0),
        axis.text.y = element_text(face = "bold", 
                                   size = 10, angle = 0,hjust = 1)) +
  #scale_y_continuous(breaks = seq(2003,2020)) + 
  guides(color = FALSE)

data_tidied_pulp_plot
```
## 3.3.3 Silverskin

```{r}
data_tidied_silverskin  <- 
  data_tidied %>% 
  separate_rows(byproduct, sep = ", ") |> 
  separate_rows(categories, sep = ", ") |> 
  filter(str_detect(byproduct, pattern = "silverskin")) %>% 
  group_by(year,categories) %>% 
  count(categories, sort = TRUE)

data_tidied_silverskin_plot <- 
  data_tidied_silverskin %>% 
  arrange(year,categories) %>% 
  mutate(categories = factor(categories)) %>% 
  ggplot(aes(y = categories, x = year, size = n, color= categories)) +
  geom_point(alpha = 1) +
  scale_x_continuous(breaks = seq(min(data_tidied_silverskin$year),
                                  max(data_tidied_silverskin$year),
                                  by = 1)) +
  scale_size(name="tags") +
  xlab("Byproducts Applications") +
  ggtitle("Silverskin applications") +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 10, angle = 45,vjust = 0),
        axis.text.y = element_text(face = "bold", 
                                   size = 10, angle = 0,hjust = 1)) +
  #scale_y_continuous(breaks = seq(2003,2020)) + 
  guides(color = FALSE)

data_tidied_silverskin_plot
```

## 3.3.4 Spent Coffee Ground

```{r}
data_tidied_spent_coffee_grounds  <- 
  data_tidied %>% 
  separate_rows(byproduct, sep = ", ") |> 
  separate_rows(categories, sep = ", ") |> 
  filter(str_detect(byproduct, pattern = "spent_coffee_grounds")) %>% 
  group_by(year,categories) %>% 
  count(categories, sort = TRUE)

data_tidied_spent_coffee_grounds_plot <- 
  data_tidied_spent_coffee_grounds %>% 
  arrange(year,categories) %>% 
  mutate(categories = factor(categories)) %>% 
  ggplot(aes(y = categories, x = year, size = n, color= categories)) +
  geom_point(alpha = 1) +
  scale_x_continuous(breaks = seq(min(data_tidied_spent_coffee_grounds$year),
                                  max(data_tidied_spent_coffee_grounds$year),
                                  by = 1)) +
  scale_size(name="tags") +
  xlab("Byproducts Applications") +
  ggtitle("Spent Coffee Grounds applications") +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 10, angle = 45,vjust = 0),
        axis.text.y = element_text(face = "bold", 
                                   size = 10, angle = 0,hjust = 1)) +
  #scale_y_continuous(breaks = seq(2003,2020)) + 
  guides(color = FALSE)

data_tidied_spent_coffee_grounds_plot
```
